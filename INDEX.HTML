<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Direct - Farm-to-Consumer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
    </style>
</head>
<body class="min-h-screen pb-28">

    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10 p-4 border-b-4 border-green-600">
        <h1 class="text-2xl font-extrabold text-green-700">Root Direct (F2C MVP)</h1>
        <p class="text-sm text-gray-500 mt-1">Sourcing fresh staples directly from Chitradurga farms to your door.</p>
    </header>

    <!-- Main Product Listing -->
    <main class="container mx-auto p-4 max-w-4xl">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Farm Staples (10 Products)</h2>
        
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Products will be dynamically loaded here -->
        </div>
    </main>

    <!-- Cart Summary (Sticky Footer) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl p-4 border-t-4 border-orange-500 z-20">
        <div class="flex justify-between items-center max-w-4xl mx-auto">
            <div class="text-lg font-bold">
                Total Items: <span id="cart-item-count" class="text-green-600">0</span><br>
                Subtotal: <span id="cart-total" class="text-orange-600">₹0.00</span>
            </div>
            <button onclick="openCheckoutModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50" id="checkout-btn" disabled>
                Checkout & Place Order
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-30 p-4" onclick="closeCheckoutModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-green-700 mb-4 border-b pb-2">Your Details</h3>
            <form id="checkout-form" onsubmit="event.preventDefault(); placeOrder()">
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Full Name</label>
                    <input type="text" id="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Mobile Number</label>
                    <input type="tel" id="phone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="e.g., 9876543210">
                </div>

                <div class="mb-6">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Delivery Address (Chitradurga City)</label>
                    <textarea id="address" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg transition duration-150 ease-in-out">
                    Confirm Order & Send via WhatsApp
                </button>
                <button type="button" onclick="closeCheckoutModal()" class="w-full mt-2 text-sm text-gray-500 hover:text-gray-700">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Imports and Initialization (Boilerplate for Future Scale) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;

        // Initialize Firebase and Auth
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Skipping full Firebase initialization.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firestore log level for debugging
                // setLogLevel('Debug'); // Assuming setLogLevel is imported or available

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Firebase signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase signed in anonymously.");
                }

                // Make instances available globally for future functions
                window.db = db;
                window.auth = auth;
                window.userId = auth.currentUser?.uid || crypto.randomUUID();
                
            } catch (error) {
                console.error("Error during Firebase setup or sign-in:", error);
            }
        }

        initializeFirebase();
    </script>

    <!-- Core Application Logic -->
    <script>
        // --- Core Data ---
        // !!! CRITICAL MANDATORY STEP !!!
        // The WhatsApp number has been successfully updated to your provided number: +91 9743919325
        const BUSINESS_WHATSAPP_NUMBER = "919743919325"; 

        const products = [
            { id: 1, name: "Ragi (Finger Millet)", unit: "1 kg", price: 45.00, img: "https://placehold.co/100x100/38a169/ffffff?text=Ragi" },
            { id: 2, name: "Groundnut (Peanut) Seeds", unit: "1 kg", price: 110.00, img: "https://placehold.co/100x100/dd6b20/ffffff?text=Nut" },
            { id: 3, name: "Toor Dal (Togari Bele)", unit: "1 kg", price: 155.00, img: "https://placehold.co/100x100/d69e2e/ffffff?text=Dal" },
            { id: 4, name: "Navane (Foxtail Millet)", unit: "1 kg", price: 85.00, img: "https://placehold.co/100x100/319795/ffffff?text=Navane" },
            { id: 5, name: "Bengal Gram (Kadale Kaalu)", unit: "500g", price: 70.00, img: "https://placehold.co/100x100/805ad5/ffffff?text=Gram" },
            { id: 6, name: "Jowar (Jola)", unit: "1 kg", price: 40.00, img: "https://placehold.co/100x100/38b2ac/ffffff?text=Jowar" },
            { id: 7, name: "Organic Jaggery Powder", unit: "500g", price: 60.00, img: "https://placehold.co/100x100/a0aec0/ffffff?text=Jagg" },
            { id: 8, name: "Byadgi Dry Chillies", unit: "250g", price: 120.00, img: "https://placehold.co/100x100/c53030/ffffff?text=Chilli" },
            { id: 9, name: "Sunflower Oil (Cold Pressed)", unit: "1 Litre", price: 230.00, img: "https://placehold.co/100x100/ecc94b/ffffff?text=Oil" },
            { id: 10, name: "Avarekai (Hyacinth Bean)", unit: "1 kg", price: 90.00, img: "https://placehold.co/100x100/9f7aea/ffffff?text=Avare" }
        ];

        let cart = {}; // {productId: quantity}

        // --- Utility Functions ---

        function formatPrice(amount) {
            return `₹${amount.toFixed(2)}`;
        }

        function updateCart(productId, change) {
            let currentQuantity = cart[productId] || 0;
            let newQuantity = currentQuantity + change;

            if (newQuantity <= 0) {
                delete cart[productId];
                newQuantity = 0;
            } else {
                cart[productId] = newQuantity;
            }

            // Update the display counter for the specific product
            const counterElement = document.getElementById(`qty-${productId}`);
            if (counterElement) {
                counterElement.textContent = newQuantity;
            }
            
            // Re-render totals
            updateTotals();
        }

        function updateTotals() {
            let totalAmount = 0;
            let totalItems = 0;

            for (const productId in cart) {
                const quantity = cart[productId];
                const product = products.find(p => p.id == productId);

                if (product && quantity > 0) {
                    totalAmount += product.price * quantity;
                    totalItems += quantity;
                }
            }

            // Update the sticky footer display
            document.getElementById('cart-item-count').textContent = totalItems;
            document.getElementById('cart-total').textContent = formatPrice(totalAmount);
            
            // Enable/Disable checkout button
            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = totalItems === 0;
            checkoutBtn.textContent = totalItems === 0 ? 'Add items to order' : `Checkout (${formatPrice(totalAmount)})`;
        }

        // --- UI Rendering ---

        function createProductCard(product) {
            const currentQty = cart[product.id] || 0;
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4 transition transform hover:shadow-xl hover:scale-[1.01]';
            
            // Product Image (Placeholder)
            const img = document.createElement('img');
            img.src = product.img;
            img.alt = product.name;
            img.className = 'w-16 h-16 rounded-lg object-cover border border-gray-200';

            // Product Info
            const info = document.createElement('div');
            info.className = 'flex-grow';
            info.innerHTML = `
                <h3 class="text-lg font-bold text-gray-800">${product.name}</h3>
                <p class="text-sm text-gray-500">${product.unit} | Price: <span class="text-green-600 font-semibold">${formatPrice(product.price)}</span></p>
            `;

            // Quantity Controls
            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-2';
            
            const minusBtn = document.createElement('button');
            minusBtn.className = 'bg-orange-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold hover:bg-orange-600';
            minusBtn.textContent = '-';
            minusBtn.onclick = () => updateCart(product.id, -1);
            
            const qtySpan = document.createElement('span');
            qtySpan.id = `qty-${product.id}`;
            qtySpan.className = 'text-lg font-semibold w-4 text-center';
            qtySpan.textContent = currentQty;

            const plusBtn = document.createElement('button');
            plusBtn.className = 'bg-green-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold hover:bg-green-700';
            plusBtn.textContent = '+';
            plusBtn.onclick = () => updateCart(product.id, 1);
            
            controls.append(minusBtn, qtySpan, plusBtn);

            card.append(img, info, controls);
            return card;
        }

        function renderProducts() {
            const listElement = document.getElementById('product-list');
            listElement.innerHTML = '';
            products.forEach(product => {
                listElement.appendChild(createProductCard(product));
            });
            updateTotals();
        }

        // --- Modal Control ---

        function openCheckoutModal() {
            if (Object.keys(cart).length === 0) {
                 // In a real app, this would be a message box, but since we cannot use 'alert'
                 console.log("Cart is empty. Please add products.");
                 return;
            }
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.getElementById('checkout-modal').classList.add('flex');
            // Restore previous input values if they exist
            document.getElementById('name').value = localStorage.getItem('order_name') || '';
            document.getElementById('phone').value = localStorage.getItem('order_phone') || '';
            document.getElementById('address').value = localStorage.getItem('order_address') || '';
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('checkout-modal').classList.remove('flex');
        }

        // --- Order Submission (MVP WhatsApp Focus) ---

        function placeOrder() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const form = document.getElementById('checkout-form');

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // 1. Save user details to local storage (MVP persistent data)
            localStorage.setItem('order_name', name);
            localStorage.setItem('order_phone', phone);
            localStorage.setItem('order_address', address);

            // 2. Build the order summary text
            let orderSummary = "Hello Root Direct,\n\nI want to place the following order:\n\n*--- ORDER DETAILS ---*\n";
            let totalAmount = 0;

            for (const productId in cart) {
                const quantity = cart[productId];
                const product = products.find(p => p.id == productId);

                if (product && quantity > 0) {
                    const lineTotal = product.price * quantity;
                    totalAmount += lineTotal;
                    orderSummary += `• ${product.name} (${product.unit}): ${quantity} units @ ${formatPrice(product.price)} = ${formatPrice(lineTotal)}\n`;
                }
            }

            orderSummary += `\n*GRAND TOTAL: ${formatPrice(totalAmount)}*\n\n`;
            orderSummary += "*--- CUSTOMER DETAILS ---*\n";
            orderSummary += `Name: ${name}\n`;
            orderSummary += `Contact: ${phone}\n`;
            orderSummary += `Address: ${address}\n`;
            orderSummary += `\n*Please confirm the order and delivery time. Thank thank you!*`;


            // 3. Encode the message and open WhatsApp
            const encodedMessage = encodeURIComponent(orderSummary);
            const whatsappUrl = `https://wa.me/${BUSINESS_WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            // Note: Use window.open to avoid issues with iframe restrictions
            window.open(whatsappUrl, '_blank');

            // 4. Close modal and reset cart (Optional: Clear cart after successful order)
            closeCheckoutModal();
            cart = {};
            renderProducts(); // Re-render to clear counters
        }

        // Initial load
        window.onload = function() {
            renderProducts();
        };

    </script>
</body>
</html>
