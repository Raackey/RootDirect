<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Direct - Farm Staples</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        /* Custom styles for professional appearance */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen pb-28">

    <!-- Header -->
    <header class="sticky top-0 bg-white card-shadow z-10 p-4 border-b-4 border-green-700">
        <h1 class="text-3xl font-extrabold text-green-800">Root Direct</h1>
        <p class="text-sm text-gray-600 mt-1">Farm-to-consumer quality from Chitradurga. UPI & Bank payments accepted.</p>
    </header>

    <!-- Main Product Listing -->
    <main class="container mx-auto p-4 max-w-4xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-3">Seasonal Staples</h2>
        
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Products will be dynamically loaded here -->
        </div>
    </main>

    <!-- Cart Summary (Sticky Footer) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white card-shadow p-4 border-t-4 border-orange-600 z-20">
        <div class="flex justify-between items-center max-w-4xl mx-auto">
            <div class="text-lg font-bold">
                Items: <span id="cart-item-count" class="text-green-700">0</span><br>
                Total: <span id="cart-total" class="text-orange-600 text-xl">₹0.00</span>
            </div>
            <button onclick="openCheckoutModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-150 ease-in-out disabled:opacity-50" id="checkout-btn" disabled>
                Proceed to Order
            </button>
        </div>
    </div>

    <!-- Checkout Modal: Step 1 (Details) -->
    <div id="checkout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-30 p-4" onclick="closeCheckoutModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-green-700 mb-4 border-b pb-2">1. Delivery Details</h3>
            <form id="checkout-form" onsubmit="event.preventDefault(); proceedToPayment()">
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Full Name</label>
                    <input type="text" id="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Mobile Number</label>
                    <input type="tel" id="phone" pattern="[0-9]{10}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="e.g., 9876543210 (10 digits)">
                </div>

                <div class="mb-6">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Delivery Address (Chitradurga City)</label>
                    <textarea id="address" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    Next: View Payment Options
                </button>
                <button type="button" onclick="closeCheckoutModal()" class="w-full mt-2 text-sm text-gray-500 hover:text-gray-700">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- Payment Modal: Step 2 (Payment & Confirmation) -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40 p-4" onclick="closePaymentModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-green-700 mb-4 border-b pb-2">2. Payment & Confirmation</h3>
            
            <p class="text-lg font-semibold mb-2">Order Total: <span id="payment-total" class="text-orange-600"></span></p>

            <!-- Payment Details (COD, UPI, Bank Transfer) -->
            <div class="space-y-4 mb-6">
                
                <!-- Option 1: Cash on Delivery (COD) -->
                <div class="border p-4 rounded-lg bg-yellow-50 border-yellow-300">
                    <h4 class="font-bold text-xl text-yellow-800 mb-2 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0l-2 2m2-2l2 2m7-2h2a2 2 0 002-2v-4a2 2 0 00-2-2h-2"></path></svg>
                        Option 1: Cash on Delivery (COD)
                    </h4>
                    <p class="text-sm text-gray-700">Pay the full amount when the delivery agent arrives with your order.</p>
                </div>

                <!-- Option 2: UPI Payment (Preferred) -->
                <div class="border p-4 rounded-lg bg-green-50 border-green-300">
                    <h4 class="font-bold text-lg text-green-700 mb-2">Option 2: UPI Payment (Preferred)</h4>
                    <p class="text-sm text-gray-700">Scan this QR code or use the VPA below to pay the total amount.</p>
                    <!-- Mock QR Code Placeholder (Replace with your own QR image URL later) -->
                    <img src="https://placehold.co/150x150/007bff/ffffff?text=UPI+QR+CODE" alt="UPI QR Code Placeholder" class="my-3 rounded-md border">
                    <p class="font-mono text-sm break-all">VPA: **rootdirect@upi**</p>
                </div>

                <!-- Option 3: Bank Transfer -->
                <div class="border p-4 rounded-lg bg-blue-50 border-blue-300">
                    <h4 class="font-bold text-lg text-blue-700 mb-2">Option 3: Bank Transfer</h4>
                    <p class="text-sm text-gray-700">Pay using NEFT/IMPS before or after confirming the order via WhatsApp.</p>
                    <p class="text-sm mt-2">
                        Bank Name: **State Bank of India**<br>
                        A/C Holder: **Root Direct Enterprises**<br>
                        Account No: **12345678901**<br>
                        IFSC Code: **SBIN0000123**
                    </p>
                </div>
            </div>

            <button onclick="placeOrder()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out">
                Confirm Order & Send via WhatsApp
            </button>
            <button type="button" onclick="closePaymentModal()" class="w-full mt-2 text-sm text-gray-500 hover:text-gray-700">
                Go Back to Details
            </button>
        </div>
    </div>

    <!-- Firebase SDK Imports and Initialization (Boilerplate for Future Scale) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Skipping full Firebase initialization.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                window.db = db;
                window.auth = auth;
                window.userId = auth.currentUser?.uid || crypto.randomUUID();
                
            } catch (error) {
                console.error("Error during Firebase setup or sign-in:", error);
            }
        }

        initializeFirebase();
    </script>

    <!-- Core Application Logic -->
    <script>
        // --- Configuration ---
        const BUSINESS_WHATSAPP_NUMBER = "919743919325"; // Your final, confirmed number
        let totalOrderAmount = 0; // Global variable to store the final total

        // --- Multi-Option Product Data Structure ---
        // Each product has a list of 'options' (SKUs) with unique skuIds for tracking in the cart.
        const allProducts = [
            { id: 1, name: "Premium Ragi (Finger Millet)", img: "https://images.unsplash.com/photo-1627953289947-a42e7535492d?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/38a169/ffffff?text=Ragi", options: [
                { skuId: '1-a', unit: '500 g', price: 35.00 },
                { skuId: '1-b', unit: '1 kg', price: 70.00 },
                { skuId: '1-c', unit: '5 kg', price: 340.00 }
            ]},
            { id: 2, name: "Jowar (Sorghum)", img: "https://images.unsplash.com/photo-1627953291264-9f4a5118f7a6?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/dd6b20/ffffff?text=Jowar", options: [
                { skuId: '2-a', unit: '500 g', price: 25.00 },
                { skuId: '2-b', unit: '1 kg', price: 50.00 },
                { skuId: '2-c', unit: '5 kg', price: 250.00 }
            ]},
            { id: 3, name: "Dry Coconut (Kobbari)", img: "https://images.unsplash.com/photo-1614949504446-271708849b28?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/d69e2e/ffffff?text=Kobbari", options: [
                { skuId: '3-a', unit: '500 g', price: 90.00 },
                { skuId: '3-b', unit: '1 kg', price: 180.00 },
                { skuId: '3-c', unit: '5 kg', price: 900.00 }
            ]},
            { id: 4, name: "Groundnut (Peanut) Seeds", img: "https://images.unsplash.com/photo-1549419163-9af5691e84a2?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/319795/ffffff?text=Nut+Seed", options: [
                { skuId: '4-a', unit: '500 g', price: 80.00 },
                { skuId: '4-b', unit: '1 kg', price: 150.00 },
                { skuId: '4-c', unit: '5 kg', price: 750.00 }
            ]},
            { id: 5, name: "Toor Dal (Pigeon Pea Split)", img: "https://images.unsplash.com/photo-1627953291242-706f97970d24?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/a0aec0/ffffff?text=Toor+Dal", options: [
                { skuId: '5-a', unit: '500 g', price: 80.00 },
                { skuId: '5-b', unit: '1 kg', price: 155.00 },
                { skuId: '5-c', unit: '5 kg', price: 750.00 }
            ]},
            { id: 6, name: "Navane (Foxtail Millet)", img: "https://images.unsplash.com/photo-1638202996515-56450f3f66a9?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/f6ad55/ffffff?text=Navane", options: [
                { skuId: '6-a', unit: '500 g', price: 45.00 },
                { skuId: '6-b', unit: '1 kg', price: 85.00 },
                { skuId: '6-c', unit: '5 kg', price: 400.00 }
            ]},
            { id: 7, name: "Local Green Moong Dal", img: "https://images.unsplash.com/photo-1616016668740-4202d603a152?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/ecc94b/ffffff?text=Moong", options: [
                { skuId: '7-a', unit: '500 g', price: 40.00 },
                { skuId: '7-b', unit: '1 kg', price: 80.00 },
                { skuId: '7-c', unit: '5 kg', price: 400.00 }
            ]},
            { id: 8, name: "Cold Pressed Groundnut Oil", img: "https://images.unsplash.com/photo-1607592237834-40660a9270a6?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/065f46/ffffff?text=G.Nut+Oil", options: [
                { skuId: '8-a', unit: '1 Litre', price: 380.00 }
            ]},
            { id: 9, name: "Cold Pressed Coconut Oil", img: "https://images.unsplash.com/photo-1604104597152-ee702951f33f?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/065f46/ffffff?text=Coco+Oil", options: [
                { skuId: '9-a', unit: '1 Litre', price: 350.00 }
            ]},
            { id: 10, name: "Castor Seeds", img: "https://images.unsplash.com/photo-1627953290374-e88924b123a6?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/9f7aea/ffffff?text=Castor+Seed", options: [
                { skuId: '10-a', unit: '500 g', price: 35.00 },
                { skuId: '10-b', unit: '1 kg', price: 70.00 },
                { skuId: '10-c', unit: '5 kg', price: 350.00 }
            ]},
            { id: 11, name: "Cold Pressed Castor Oil", img: "https://images.unsplash.com/photo-1596707328608-251c6c559814?q=80&w=150&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", fallback: "https://placehold.co/150x150/065f46/ffffff?text=Castor+Oil", options: [
                { skuId: '11-a', unit: '1 Litre', price: 300.00 }
            ]}
        ];

        let cart = {}; // Cart now stores quantities based on unique 'skuId' (e.g., '1-b': 2)

        // --- Utility Functions ---

        function formatPrice(amount) {
            return `₹${amount.toFixed(2)}`;
        }
        
        // Helper function to find a product and its specific option/SKU
        function getProductBySkuId(skuId) {
            const [productId] = skuId.split('-');
            const product = allProducts.find(p => p.id == productId);
            if (!product) return null;
            const option = product.options.find(o => o.skuId === skuId);
            if (!option) return null;
            return { product, option };
        }

        function updateCart(skuId, change) {
            let currentQuantity = cart[skuId] || 0;
            let newQuantity = currentQuantity + change;

            if (newQuantity <= 0) {
                delete cart[skuId];
                newQuantity = 0;
            } else {
                cart[skuId] = newQuantity;
            }

            // Update the quantity displayed next to the unit
            const counterElement = document.getElementById(`qty-${skuId}`);
            if (counterElement) {
                counterElement.textContent = newQuantity;
            }
            
            updateTotals();
        }

        function updateTotals() {
            totalOrderAmount = 0;
            let totalItems = 0;

            for (const skuId in cart) {
                const quantity = cart[skuId];
                const data = getProductBySkuId(skuId);

                if (data && quantity > 0) {
                    totalOrderAmount += data.option.price * quantity;
                    totalItems += quantity;
                }
            }

            document.getElementById('cart-item-count').textContent = totalItems;
            document.getElementById('cart-total').textContent = formatPrice(totalOrderAmount);
            
            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = totalItems === 0;
            checkoutBtn.textContent = totalItems === 0 ? 'Add items to order' : `Proceed (${formatPrice(totalOrderAmount)})`;
        }

        // --- UI Rendering ---

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl card-shadow flex flex-col transition hover:shadow-2xl';
            
            // Product Name and Image Header
            const header = document.createElement('div');
            header.className = 'p-4 pb-0';
            header.innerHTML = `
                <img src="${product.img}" onerror="this.src = '${product.fallback}'" alt="${product.name}" class="w-full h-32 object-cover rounded-t-xl mb-3 border-b-2 border-gray-100">
                <h3 class="text-xl font-extrabold text-gray-900 mb-2">${product.name}</h3>
            `;

            // Options List (The core change)
            const optionsList = document.createElement('div');
            optionsList.className = 'flex-grow px-4 pb-4 space-y-2';

            product.options.forEach(option => {
                const currentQty = cart[option.skuId] || 0;
                
                const optionRow = document.createElement('div');
                optionRow.className = 'flex items-center justify-between border-t pt-2';
                
                // Price and Unit
                const info = document.createElement('div');
                info.className = 'flex flex-col';
                info.innerHTML = `
                    <span class="text-lg font-bold text-green-700">${formatPrice(option.price)}</span>
                    <span class="text-xs text-gray-500 font-medium">${option.unit}</span>
                `;

                // Quantity Controls
                const qtyGroup = document.createElement('div');
                qtyGroup.className = 'flex items-center space-x-2';
                
                const minusBtn = document.createElement('button');
                minusBtn.className = 'bg-orange-500 text-white rounded-full h-7 w-7 flex items-center justify-center font-bold text-md hover:bg-orange-600 transition';
                minusBtn.textContent = '−';
                minusBtn.onclick = () => updateCart(option.skuId, -1);
                
                const qtySpan = document.createElement('span');
                qtySpan.id = `qty-${option.skuId}`;
                qtySpan.className = 'text-lg font-extrabold w-6 text-center text-gray-800';
                qtySpan.textContent = currentQty;

                const plusBtn = document.createElement('button');
                plusBtn.className = 'bg-green-600 text-white rounded-full h-7 w-7 flex items-center justify-center font-bold text-md hover:bg-green-700 transition';
                plusBtn.textContent = '+';
                plusBtn.onclick = () => updateCart(option.skuId, 1);
                
                qtyGroup.append(minusBtn, qtySpan, plusBtn);
                optionRow.append(info, qtyGroup);
                optionsList.appendChild(optionRow);
            });

            card.append(header, optionsList);
            return card;
        }

        function renderProducts() {
            const listElement = document.getElementById('product-list');
            listElement.innerHTML = '';
            allProducts.forEach(product => {
                listElement.appendChild(createProductCard(product));
            });
            updateTotals();
        }

        // --- Modal Control Functions (Unchanged) ---

        function openCheckoutModal() {
            if (Object.keys(cart).length === 0) {
                 console.log("Cart is empty. Please add products.");
                 return;
            }
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.getElementById('checkout-modal').classList.add('flex');
            // Load saved user details
            document.getElementById('name').value = localStorage.getItem('order_name') || '';
            document.getElementById('phone').value = localStorage.getItem('order_phone') || '';
            document.getElementById('address').value = localStorage.getItem('order_address') || '';
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('checkout-modal').classList.remove('flex');
        }

        function openPaymentModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            document.getElementById('payment-total').textContent = formatPrice(totalOrderAmount);
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('payment-modal').classList.add('flex');
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-modal').classList.remove('flex');
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.getElementById('checkout-modal').classList.add('flex');
        }
        
        // --- Order Flow ---

        function proceedToPayment() {
            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Save details before proceeding
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            localStorage.setItem('order_name', name);
            localStorage.setItem('order_phone', phone);
            localStorage.setItem('order_address', address);

            openPaymentModal();
        }

        function placeOrder() {
            // Retrieve saved details
            const name = localStorage.getItem('order_name') || 'N/A';
            const phone = localStorage.getItem('order_phone') || 'N/A';
            const address = localStorage.getItem('order_address') || 'N/A';
            
            // 1. Build the order summary text for WhatsApp
            let orderSummary = "Hello Root Direct Team,\n\nI have reviewed the payment options and am confirming my order:\n\n*--- ORDER DETAILS ---*\n";
            
            for (const skuId in cart) {
                const quantity = cart[skuId];
                const data = getProductBySkuId(skuId);

                if (data && quantity > 0) {
                    const lineTotal = data.option.price * quantity;
                    // Format output as: Product Name (Unit Size): X units (Total: Price)
                    orderSummary += `• ${data.product.name} (${data.option.unit}): ${quantity} units (Total: ${formatPrice(lineTotal)})\n`;
                }
            }

            orderSummary += `\n*GRAND TOTAL: ${formatPrice(totalOrderAmount)}*\n`;
            orderSummary += `\n*--- CUSTOMER DETAILS ---*\n`;
            orderSummary += `Name: ${name}\n`;
            orderSummary += `Contact: ${phone}\n`;
            orderSummary += `Delivery Address: ${address}\n`;
            orderSummary += `\n*Please confirm receipt of payment/delivery method and schedule delivery. Thank you!*`;


            // 2. Encode the message and open WhatsApp
            const encodedMessage = encodeURIComponent(orderSummary);
            const whatsappUrl = `https://wa.me/${BUSINESS_WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');

            // 3. Close modal and reset cart 
            closePaymentModal();
            cart = {};
            updateTotals(); // Resets total order amount and clears footer
            renderProducts(); // Re-render to clear counters
            
            // Optional: Show a confirmation message box (not using alert)
            console.log("Order submitted. WhatsApp chat opened.");
        }

        // Initial load
        window.onload = function() {
            renderProducts();
        };

    </script>
</body>

</html>
