<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Direct | Seasonal Staples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .product-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .qty-button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s;
        }
        .qty-button:hover {
            opacity: 0.9;
        }
        /* Responsive Grid for Products */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }
        @media (max-width: 640px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-[#38A169]">Root Direct</h1>
            <div class="flex items-center space-x-4">
                <span id="authStatus" class="text-sm text-gray-600">Status: Loading...</span>
                <!-- Button starts as Sign In, changes ID and listener on auth state change -->
                <button id="authToggleButton" class="px-4 py-2 bg-[#38A169] text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">Sign In</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-[#38A169] pb-2 mb-8">Seasonal Staples</h2>

        <!-- Product Grid -->
        <div id="productGrid" class="product-grid">
            <!-- Products will be dynamically inserted here -->
            <p id="loadingIndicator" class="text-gray-500 col-span-full text-center">Loading products...</p>
        </div>
    </main>

    <!-- Footer / Cart Summary -->
    <footer class="bg-white border-t border-gray-200 sticky bottom-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div class="text-lg font-semibold text-gray-700">
                <span id="cartItems">Items: 0</span> | <span id="cartTotal">Total: â‚¹0.00</span>
            </div>
            <button id="proceedToOrderButton" class="px-6 py-3 bg-[#38A169] text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transition duration-150 disabled:opacity-50" disabled>
                Proceed to Order
            </button>
        </div>
    </footer>

    <!-- Modals (Sign In / Order) -->

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-[#38A169]">Sign In / Register</h3>
            <p class="mb-4 text-gray-600">Sign in to manage your profile and view past orders.</p>

            <form id="authForm" class="space-y-4">
                <input type="email" id="authEmail" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-200">
                <input type="password" id="authPassword" placeholder="Password (min 6 characters)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-green-200">

                <button type="submit" id="authSubmitButton" class="w-full p-3 bg-[#38A169] text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150">Sign In</button>
                <div class="text-center text-sm">
                    <button type="button" id="toggleAuthMode" class="text-[#38A169] hover:underline">New Customer? Create Account</button>
                </div>
                <button type="button" id="closeAuthModal" class="w-full p-3 mt-2 text-gray-600 hover:text-gray-900 transition duration-150">Close</button>
                <p id="authMessage" class="text-center text-red-500 font-semibold"></p>
            </form>
        </div>
    </div>

    <!-- Order Modal (Step 1: Delivery Details) -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-orange-500" id="orderModalTitle">1. Delivery Details</h3>

            <form id="deliveryForm" class="space-y-4">
                <label class="block text-gray-700 font-semibold">Your Full Name</label>
                <input type="text" id="deliveryName" placeholder="Rakesh" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-orange-200">

                <label class="block text-gray-700 font-semibold">WhatsApp Mobile Number</label>
                <input type="tel" id="deliveryMobile" placeholder="9743919325" required pattern="[0-9]{10}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-orange-200">

                <label class="block text-gray-700 font-semibold">Delivery Address (Within Karnataka)</label>
                <textarea id="deliveryAddress" placeholder="Karnataka" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-orange-200 h-24"></textarea>

                <button type="submit" class="w-full p-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition duration-150">Next: View Payment Options</button>
                <button type="button" id="cancelOrder" class="w-full p-3 mt-2 text-gray-600 hover:text-gray-900 transition duration-150">Cancel</button>
            </form>

            <div id="paymentDetails" class="hidden">
                <p class="text-lg font-bold mt-4">Order Summary:</p>
                <ul id="orderSummaryList" class="list-disc list-inside space-y-1 text-gray-700 mb-4 ml-4"></ul>
                <p class="text-xl font-extrabold text-orange-600">Grand Total: <span id="paymentTotal"></span></p>

                <div class="mt-6 space-y-4">
                    <label class="block text-gray-700 font-semibold">Payment Option</label>
                    <div class="flex items-center space-x-4">
                        <input type="radio" id="paymentCOD" name="paymentOption" value="COD" checked class="form-radio text-orange-500">
                        <label for="paymentCOD" class="font-medium">Cash on Delivery (COD)</label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="radio" id="paymentOnline" name="paymentOption" value="Online" disabled class="form-radio text-gray-400">
                        <label for="paymentOnline" class="font-medium text-gray-400">Online Payment (Coming Soon)</label>
                    </div>
                </div>

                <button id="placeOrderButton" class="w-full p-3 mt-8 bg-[#38A169] text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150">Place Final Order</button>
                <button type="button" id="backToDelivery" class="w-full p-3 mt-2 text-gray-600 hover:text-gray-900 transition duration-150">Back to Delivery Details</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db, auth, userId = null;
        let isAuthReady = false;
        let products = [];
        let cart = {};

        // Hardcoded product data to initialize the DB on first login
        const defaultProducts = [
            { id: 'rag-01', name: 'Ragi (Finger Millet)', titleColor: 'text-white bg-[#38A169]', basePrice: 35.00, sizes: [{ size: '500 g', price: 35.00 }, { size: '1 kg', price: 70.00 }, { size: '5 kg', price: 340.00 }] },
            { id: 'jow-01', name: 'Jowar (Sorghum)', titleColor: 'text-white bg-orange-500', basePrice: 25.00, sizes: [{ size: '500 g', price: 25.00 }, { size: '1 kg', price: 50.00 }, { size: '5 kg', price: 250.00 }] },
            { id: 'kob-01', name: 'Dry Coconut (Kobbari)', titleColor: 'text-white bg-yellow-600', basePrice: 90.00, sizes: [{ size: '500 g', price: 90.00 }, { size: '1 kg', price: 180.00 }, { size: '5 kg', price: 900.00 }] },
            { id: 'nut-01', name: 'Groundnut (Peanut Seeds)', titleColor: 'text-white bg-teal-600', basePrice: 80.00, sizes: [{ size: '500 g', price: 80.00 }, { size: '1 kg', price: 150.00 }, { size: '5 kg', price: 750.00 }] },
            { id: 'dal-01', name: 'Toor Dal (Pigeon Pea Split)', titleColor: 'text-white bg-blue-400', basePrice: 80.00, sizes: [{ size: '500 g', price: 80.00 }, { size: '1 kg', price: 155.00 }, { size: '5 kg', price: 750.00 }] },
            { id: 'nav-01', name: 'Navane (Foxtail Millet)', titleColor: 'text-white bg-orange-400', basePrice: 45.00, sizes: [{ size: '500 g', price: 45.00 }, { size: '1 kg', price: 85.00 }, { size: '5 kg', price: 400.00 }] },
            { id: 'moo-01', name: 'Local Green Moong Dal', titleColor: 'text-white bg-yellow-400', basePrice: 40.00, sizes: [{ size: '500 g', price: 40.00 }, { size: '1 kg', price: 80.00 }, { size: '5 kg', price: 400.00 }] },
            { id: 'gnut-oil', name: 'Cold Pressed Groundnut Oil', titleColor: 'text-white bg-teal-800', basePrice: 380.00, sizes: [{ size: '1 Litre', price: 380.00 }] },
            { id: 'coco-oil', name: 'Cold Pressed Coconut Oil', titleColor: 'text-white bg-teal-800', basePrice: 350.00, sizes: [{ size: '1 Litre', price: 350.00 }] },
            { id: 'castor-seed', name: 'Castor Seeds', titleColor: 'text-white bg-purple-400', basePrice: 35.00, sizes: [{ size: '500 g', price: 35.00 }, { size: '1 kg', price: 70.00 }, { size: '5 kg', price: 350.00 }] },
            { id: 'castor-oil', name: 'Cold Pressed Castor Oil', titleColor: 'text-white bg-teal-800', basePrice: 300.00, sizes: [{ size: '1 Litre', price: 300.00 }] }
        ];

        // --- Utility Functions ---

        // Simple function to retry API calls with exponential backoff
        async function fetchWithRetry(fn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    console.warn(`Retry ${i + 1}/${maxRetries}: Error fetching data. Retrying in ${delay}ms.`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        function calculateCart() {
            let totalItems = 0;
            let totalAmount = 0;

            for (const productId in cart) {
                const item = cart[productId];
                totalItems += item.quantity;
                totalAmount += item.quantity * item.price;
            }

            document.getElementById('cartItems').textContent = `Items: ${totalItems}`;
            document.getElementById('cartTotal').textContent = `Total: â‚¹${totalAmount.toFixed(2)}`;
            
            // Proceed button is enabled if there are items and the user is NOT anonymous
            const proceedButton = document.getElementById('proceedToOrderButton');
            const canProceed = totalItems > 0 && userId && !auth.currentUser?.isAnonymous;
            proceedButton.disabled = !canProceed;

            // Save cart to DB
            if (isAuthReady && userId && !auth.currentUser?.isAnonymous) {
                saveCartToDB(cart).catch(err => console.error("Failed to save cart:", err));
            }
        }

        // --- Database Path Helpers ---

        function getProductsDocRef(db, userId) {
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'products');
        }

        function getCartDocRef(db, userId) {
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'cart');
        }

        function getOrdersCollectionRef(db, userId) {
             // Store orders in the public collection for future admin access
             return collection(db, 'artifacts', appId, 'public', 'data', 'orders');
        }


        // --- Database Operations ---

        async function initializeProducts(db, userId) {
            const productsDocRef = getProductsDocRef(db, userId);
            const docSnap = await getDoc(productsDocRef);

            if (!docSnap.exists()) {
                // If products don't exist, save the default set
                console.log("No products found. Initializing with default data.");
                const data = { products: defaultProducts, lastUpdated: new Date() };
                await setDoc(productsDocRef, data);
                return defaultProducts;
            } else {
                console.log("Products loaded from database.");
                return docSnap.data().products || [];
            }
        }

        async function saveCartToDB(currentCart) {
            if (!userId || !db) return;
            const cartDocRef = getCartDocRef(db, userId);
            const data = { cart: currentCart, lastUpdated: new Date() };
            await setDoc(cartDocRef, data);
        }

        async function saveOrderToDB(orderData) {
            if (!userId || !db) return;
            const ordersColRef = getOrdersCollectionRef(db, userId);

            // Add the new order document
            await addDoc(ordersColRef, {
                ...orderData,
                userId: userId,
                timestamp: new Date()
            });
            console.log("Order placed successfully!");
        }

        // --- Render Functions ---

        function renderProducts(currentProducts) {
            products = currentProducts;
            const grid = document.getElementById('productGrid');
            grid.innerHTML = ''; // Clear existing content
            document.getElementById('loadingIndicator')?.classList.add('hidden');

            if (products.length === 0) {
                grid.innerHTML = '<p class="text-xl text-gray-500 col-span-full text-center py-12">No products available. Please sign in to load the default catalog.</p>';
                return;
            }

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white rounded-xl overflow-hidden shadow-lg border border-gray-100 p-4';

                // Product Title Header
                const headerBg = product.titleColor.includes('bg-') ? product.titleColor.split(' ').find(c => c.startsWith('bg-')) : 'bg-gray-800';
                card.innerHTML = `
                    <div class="rounded-lg mb-4 text-center p-6 ${headerBg}">
                        <h3 class="text-4xl font-extrabold text-white">${product.name.split('(')[0].trim()}</h3>
                        <p class="text-white font-medium">${product.name.includes('(') ? product.name.split('(')[1].replace(')', '').trim() : ''}</p>
                    </div>
                    <p class="text-lg font-semibold text-gray-800 mb-4">${product.name}</p>
                `;

                product.sizes.forEach((sizeOption, index) => {
                    // Unique ID for this size option in the cart: productID-sizeIndex
                    const cartId = `${product.id}-${index}`;
                    const currentQty = cart[cartId] ? cart[cartId].quantity : 0;

                    const sizeDiv = document.createElement('div');
                    sizeDiv.className = 'flex justify-between items-center py-2 border-t border-gray-100';
                    sizeDiv.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-lg font-bold text-green-600">â‚¹${sizeOption.price.toFixed(2)}</span>
                            <span class="text-sm text-gray-500">${sizeOption.size}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button data-cart-id="${cartId}" data-action="decrement" class="qty-button bg-orange-100 text-orange-600 rounded-full hover:bg-orange-200">-</button>
                            <span id="qty-${cartId}" class="w-8 text-center font-bold text-gray-700">${currentQty}</span>
                            <button data-cart-id="${cartId}" data-action="increment" class="qty-button bg-green-100 text-green-600 rounded-full hover:bg-green-200">+</button>
                        </div>
                    `;
                    card.appendChild(sizeDiv);
                });

                grid.appendChild(card);
            });
        }

        // --- Event Handlers ---

        function handleCartUpdate(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const cartId = button.dataset.cartId;
            const action = button.dataset.action;

            if (!cartId) return;

            const [productId, sizeIndexStr] = cartId.split('-');
            const sizeIndex = parseInt(sizeIndexStr);

            const product = products.find(p => p.id === productId);
            if (!product || !product.sizes[sizeIndex]) return;

            const sizeOption = product.sizes[sizeIndex];

            // Initialize item if it doesn't exist
            if (!cart[cartId]) {
                cart[cartId] = {
                    productId: productId,
                    productName: product.name,
                    size: sizeOption.size,
                    price: sizeOption.price,
                    quantity: 0
                };
            }

            let newQty = cart[cartId].quantity;

            if (action === 'increment') {
                newQty++;
            } else if (action === 'decrement' && newQty > 0) {
                newQty--;
            }

            if (newQty > 0) {
                cart[cartId].quantity = newQty;
            } else {
                delete cart[cartId]; // Remove item if quantity is zero
            }

            // Update UI for the specific item
            const qtySpan = document.getElementById(`qty-${cartId}`);
            if (qtySpan) {
                qtySpan.textContent = newQty;
            }

            calculateCart();
        }

        function setupListeners() {
            // Product Grid click listener for cart updates
            document.getElementById('productGrid').addEventListener('click', handleCartUpdate);

            // Auth Modal Listeners
            document.getElementById('authToggleButton').addEventListener('click', () => {
                if (!userId || auth.currentUser.isAnonymous) {
                    // Only show modal if user is guest/anonymous
                    document.getElementById('authMessage').textContent = '';
                    document.getElementById('authModal').style.display = 'block';
                }
                // Sign out logic is handled dynamically in onAuthStateChanged
            });

            document.getElementById('closeAuthModal').addEventListener('click', () => {
                document.getElementById('authModal').style.display = 'none';
            });

            // Toggle Sign In / Create Account
            let isSignInMode = true;
            const authForm = document.getElementById('authForm');
            const authSubmitButton = document.getElementById('authSubmitButton');
            const toggleAuthModeButton = document.getElementById('toggleAuthMode');

            toggleAuthModeButton.addEventListener('click', (e) => {
                e.preventDefault();
                isSignInMode = !isSignInMode;
                if (isSignInMode) {
                    authSubmitButton.textContent = 'Sign In';
                    toggleAuthModeButton.textContent = 'New Customer? Create Account';
                } else {
                    authSubmitButton.textContent = 'Create Account';
                    toggleAuthModeButton.textContent = 'Already a Customer? Sign In';
                }
                document.getElementById('authMessage').textContent = '';
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const messageEl = document.getElementById('authMessage');
                messageEl.textContent = 'Processing...';

                try {
                    if (isSignInMode) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    document.getElementById('authModal').style.display = 'none';
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    let errorMessage = 'An unknown error occurred.';
                    if (error.code) {
                        errorMessage = error.message.replace('Firebase: ', '').replace(/\(.*\)/, '').trim();
                    }
                    messageEl.textContent = errorMessage;
                    console.error("Auth Error:", error);
                }
            });

            // Order Modal Listeners
            document.getElementById('proceedToOrderButton').addEventListener('click', () => {
                if (!userId || auth.currentUser?.isAnonymous) {
                     alertModal("Sign In Required", 'Please sign in or create an account before placing an order.');
                     return;
                }
                // Reset to step 1
                document.getElementById('orderModalTitle').textContent = '1. Delivery Details';
                document.getElementById('deliveryForm').classList.remove('hidden');
                document.getElementById('paymentDetails').classList.add('hidden');
                document.getElementById('orderModal').style.display = 'block';
            });

            document.getElementById('cancelOrder').addEventListener('click', () => {
                document.getElementById('orderModal').style.display = 'none';
            });

            document.getElementById('backToDelivery').addEventListener('click', () => {
                document.getElementById('orderModalTitle').textContent = '1. Delivery Details';
                document.getElementById('deliveryForm').classList.remove('hidden');
                document.getElementById('paymentDetails').classList.add('hidden');
            });

            // Handle Delivery Form Submission (Step 1 -> 2)
            document.getElementById('deliveryForm').addEventListener('submit', (e) => {
                e.preventDefault();

                // Build order summary for step 2
                const summaryList = document.getElementById('orderSummaryList');
                summaryList.innerHTML = '';
                let totalAmount = 0;

                for (const cartId in cart) {
                    const item = cart[cartId];
                    if (item.quantity > 0) {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${item.quantity} x ${item.productName} (${item.size}) @ â‚¹${item.price.toFixed(2)} = â‚¹${(item.quantity * item.price).toFixed(2)}`;
                        summaryList.appendChild(listItem);
                        totalAmount += item.quantity * item.price;
                    }
                }

                document.getElementById('paymentTotal').textContent = `â‚¹${totalAmount.toFixed(2)}`;

                // Switch to payment view
                document.getElementById('orderModalTitle').textContent = '2. Confirm Order & Payment';
                document.getElementById('deliveryForm').classList.add('hidden');
                document.getElementById('paymentDetails').classList.remove('hidden');
            });

            // Handle Place Order Button (Step 2 -> Final)
            document.getElementById('placeOrderButton').addEventListener('click', async () => {
                const orderData = {
                    customerName: document.getElementById('deliveryName').value,
                    mobile: document.getElementById('deliveryMobile').value,
                    address: document.getElementById('deliveryAddress').value,
                    items: Object.values(cart).filter(item => item.quantity > 0),
                    total: parseFloat(document.getElementById('paymentTotal').textContent.replace('â‚¹', '')),
                    paymentMethod: document.querySelector('input[name="paymentOption"]:checked').value,
                    status: 'Pending'
                };

                try {
                    document.getElementById('placeOrderButton').textContent = 'Placing Order...';
                    document.getElementById('placeOrderButton').disabled = true;

                    await saveOrderToDB(orderData);

                    // Clear cart after successful order
                    cart = {};
                    calculateCart();
                    renderProducts(products); // Re-render to show 0 quantity

                    // Show success message
                    alertModal("Success", `Order placed successfully! Total: â‚¹${orderData.total.toFixed(2)}. We will contact you shortly on WhatsApp.`);
                    document.getElementById('orderModal').style.display = 'none';

                } catch (error) {
                    console.error("Error placing order:", error);
                    alertModal("Error", "There was an error placing your order. Please try again.");
                } finally {
                    document.getElementById('placeOrderButton').textContent = 'Place Final Order';
                    document.getElementById('placeOrderButton').disabled = false;
                }
            });
        }


        // Custom Alert/Message Box Function (Replaces alert())
        function alertModal(title, message) {
            // A simple modal/dialog can be implemented here, but for this environment,
            // we will use the native window.alert().
            window.alert(`${title}\n\n${message}`);
        }

        // --- Firebase Initialization and Auth Logic (FIXED) ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Initial authentication attempt (runs only once on load)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken && initialAuthToken.length > 0) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up all static event listeners
                setupListeners();
                
                // Auth State Listener: This is the core logic that runs every time the user signs in or out.
                // FIX 1: This is now safely inside initFirebase after 'auth' is defined.
                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    const statusEl = document.getElementById('authStatus');
                    let toggleBtn = document.getElementById('authToggleButton');

                    // ----------------------------------------------------
                    // FIX 2: Handle button cloning/replacement for safe listener attachment
                    // Always clone the button to remove old listeners before setting the new one.
                    const newToggleBtn = toggleBtn.cloneNode(true);
                    toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
                    toggleBtn = newToggleBtn; 
                    // ----------------------------------------------------

                    if (user) {
                        userId = user.uid;
                        const isAnon = user.isAnonymous;

                        console.log(`User state changed. User ID: ${userId}, Anonymous: ${isAnon}`);

                        // 1. Update UI to Signed In/Guest
                        statusEl.innerHTML = isAnon ? 'Status: Guest' : `User ID: <span class="font-mono text-xs">${userId}</span>`;
                        toggleBtn.textContent = 'Sign Out';

                        // Attach Sign Out listener
                        toggleBtn.addEventListener('click', async () => {
                            try {
                                await signOut(auth);
                            } catch (error) {
                                console.error("Sign Out Error:", error);
                            }
                        });

                        // 2. Load/Initialize Products
                        try {
                            const fetchedProducts = await fetchWithRetry(() => initializeProducts(db, userId));
                            products = fetchedProducts;
                        } catch (error) {
                            console.error("Failed to fetch/initialize products:", error);
                        }

                        // 3. Load Cart (if logged in)
                        try {
                            const cartDocRef = getCartDocRef(db, userId);
                            // Set up the real-time listener for the cart
                            onSnapshot(cartDocRef, (docSnap) => {
                                const newCart = docSnap.data()?.cart || {};
                                // Only update if the content has actually changed (or first load)
                                if (JSON.stringify(cart) !== JSON.stringify(newCart)) {
                                    cart = newCart;
                                    calculateCart();
                                    renderProducts(products);
                                }
                            }, (error) => {
                                console.error("Error setting up cart listener:", error);
                            });
                        } catch (error) {
                            console.error("Failed to set up cart listener (initial):", error);
                        }

                        // Initial render of products
                        renderProducts(products);
                        calculateCart(); // Update cart status

                    } else {
                        // Signed Out State
                        userId = null;
                        cart = {};
                        products = [];

                        // 1. Update UI to Signed Out/Guest
                        statusEl.textContent = 'Status: Guest';
                        toggleBtn.textContent = 'Sign In';

                        // Attach Sign In listener (to open modal)
                        toggleBtn.addEventListener('click', () => {
                            document.getElementById('authMessage').textContent = '';
                            document.getElementById('authModal').style.display = 'block';
                        });

                        // 2. Clear Cart and Products UI
                        calculateCart();
                        renderProducts(products); // Render empty list
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loadingIndicator').textContent = 'Error loading application. Check console for details.';
            }
        }

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
